<!DOCTYPE html>
<html>
<head>
    <title></title>
	<meta charset="utf-8" />
</head>
<body>
<script>
    (function (Global,document) {
        var yi = Global.yi = Global.$y = function () { }

        yi.Observable = function(){
            var $_META = {
                description:"可观察对象。观察者模式的实现"
            };//META_$
            this.subscribe = function (name, listener) {
                var $_META = {
                    description: "订阅一个事件",
                    params: {
                        name: "事件名",
                        listener: "监听者，必须是函数"
                    },
                    returns : "观察者对象"
                };//META_$
                var ob = this["!observable.subscribes"] || (this["@observable.subscribes"]={});
                var listeners = ob[name] || (ob[name]=[]);
                listeners.push(tgt);
                return this;
            }
            this.unsubscribe = function (name, listener) {
                var $_META = {
                    description: "取消订阅一个事件",
                    params: {
                        name: "事件名",
                        listener: "监听者，必须是函数"
                    },
                    returns: "观察者对象"
                };//META_$
                var ob = this["!observable.subscribes"];if(!ob)return this;
                var listeners = ob[name];if(!listeners)return this;
                for(var i=0,j=listeners.length;i<j;i++){
                    var fn;
                    if((fn=listeners.shift())!==listener) listeners.push(fn);
                }
                return this;
            }
            this.publish = function (name, params, apply) {
                var $_META = {
                    description: "发布一个事件",
                    params: {
                        name: "事件名",
                        params: "事件参数。默认",
                        apply : "是否用apply方式调用"
                    },
                    returns: "观察者对象"
                };//META_$

                var ob = this["!observable.subscribes"]; if (!ob) return this;
                var listeners = ob[name];if(!listeners)return this;
                for(var i=0,j=listeners.length;i<j;i++){
                    var listener = listeners[i];
                    var rs = (apply) ? listener.apply(this,args):listener.call(this,args);
                    if(rs!=='%discard')listeners.push(listener);
                    if(rs==='%interrupt')return this;
                }
                return this;
            }
        }
        yi.Observable.make = function (name,code) {
            var subscribeCode = "(this[\"!" + name + "\"]||(this[\"!" + name + "\"]=[])).push(listener);return this;";
            var unsubscribeCode = "var sb,fn;if(!(sb=this[\"!" + name + "\"]))return this;for(var i=0,j=sb.length;i<j;i++)if((fn=sb.shift())!==listener) sb.push(fn);return this;";
            var publishCode = "var sb,fn;if(!(sb=this[\"!" + name + "\"]))return this;for(var i=0,j=sb.length;i<j;i++){var fn = sb.shift();var rs = apply?fn.apply(this,params):fn.call(this,params);if(rs!==\"%discard\")sb.push(fn);if(rs==='%interrupt')return '%interrupt';}return this;";
			if(code) publishCode = code + publishCode;
            var result = {};
            result.subscribe = new Function("listener", subscribeCode);
            result.unsubscribe = new Function("listener", unsubscribeCode);
            result.publishCode = new Function("params", "apply", publishCode);
            return result;
        }

        var Defer = yi.Defer = Global.$Defer = function (cb, delay,fields) { 
			if(!cb) return this;
			if(fields) for(var n in fields) this[n] = fields[n];
			var t = typeof(cb);
			if(t ==='function'){
				if(delay===undefined) {cb.call(this,this);}
				else setTimeout(function(){cb.call(this,this);},parseInt(delay)||0);
				return this;
			}
			if(cb.success && cb.fail && db.change){
				//如果第一个参数本身就是个Defer,生成一个代理Defer
				var init = function(df){
					cb.fail(function(){
						df.reject.apply(df,arguments);
					}).success(function(){
						df.resolve.apply(df,arguments);
					}).change(function(){
						df.notify.apply(df,arguments);
					});
				}
				this.proxyTo = cb;
				var me = this;
				if(delay===undefined) init(this);
				else setTimeout(function(){init(me);},parseInt(delay)||0);
				return this;
			}
			
			var fn = function(defer){
				var result = t.length && t.push && t.pop ?[]:{},hasError = false,c=0,total =0;
				var dfs = cb;
				for(var n in dfs){
					total++;c++;
					(function(index,df){
						if(!df.success || !df.fail) df = new Defer(df);
						df.success(function(rs){
							result[index] = rs;
							if(hasError)return;
							if(--c==0) defer.resolve(result);
							defer.change(c,total);
							return;
						}).fail(function(err){
							if(hasError) return;
							defer.fail({
								index:index,
								error:err
							});
							return;
						});
					})(n,dfs[n]);
				}
			}
			if(delay===undefined) {cb.call(this,this);}
			else setTimeout(function(){cb.call(this,this);},parseInt(delay)||0);
			return this;
			
		}
        yi.Defer.prototype = {
			"@defer.status":null,
			"@defer.result":undefined,
			"@defer.success":undefined,
			"@defer.fail":undefined,
			"@defer.change":undefined,
			isResolved:false,
			isRejected:false,
			resolve : function(args,apply){
				var its,state = this["@defer.status"];
				this.isResolved = true;this.isRejected = false;
				this["@defer.status"]='defer.resolved';
				this["@defer.result"] = args;
				this["@defer.apply"] = apply;
				
				
				if(its=this["@defer.success"]){
					var reuse =[];
					for(var i=0,j=its.length;i<j;i++) {
						var it = its.shift();
						var rs = apply?it.apply(this,args):it.call(this,args);
						if(rs==='%reenter') reuse.push(it);else if(rs==='%interrupt')break;
						else if(rs==='%reenter&interrupt'){
							reuse.push(it);break;
						}
					}
					this["@defer.success"]=(reuse.length)?resue:[]; 
				}
				
				if(its=this["@defer.change"]){
					for(var i=0,j=its.length;i<j;i++) {
						var it = its.shift();
						var rs = it.call(this,'defer.resolved',state);
						if(rs!=='%discard') its.push(it);else if(rs==='%interrupt')break;
					}
				}
				
				return this;
			},
			reject : function(args,apply){
				var its,state = this["@defer.status"];
				this.isResolved = false;this.isRejected = true;
				this["@defer.status"]='defer.rejected';
				this["@defer.result"] = args;
				this["@defer.apply"] = apply;
				
				if(its=this["@defer.fail"]){
					var reuse =[];
					for(var i=0,j=its.length;i<j;i++) {
						var it = its.shift();
						var rs = apply?it.apply(this,args):it.call(this,args);
						if(rs==='%reenter') reuse.push(it);else if(rs==='%interrupt')break;
						else if(rs==='%reenter&interrupt'){
							reuse.push(it);break;
						}
					}
					this["@defer.fail"]=(reuse.length)?resue:[]; 
				}
				
				if(its=this["@defer.change"]){
					for(var i=0,j=its.length;i<j;i++) {
						var it = its.shift();
						var rs = it.call(this,'defer.fail',state);
						if(rs!=='%discard') its.push(it);if(rs==='%interrupt') break;
					}
				}
				return this;
			},
			notify : function(state,param){
				var its,old = this["@defer.status"];
				this["@defer.status"] = state;
				if(its=this["@defer.change"]){
					for(var i=0,j=its.length;i<j;i++) {
						var it = its.shift();
						var rs = it.call(this,state,old,param);
						if(rs!=='%discard') its.push(it);if(rs==='%interrupt') break;
					}
				}
				return this;
			},
			success : function(cb,remove){
				if(!cb)return this;
				if(remove){
					var its = this["@defer.success"]
					if(its)for(var i=0,j=its.length;i<j;i++){
						if((it=its.shift())!==cb) its.push(it);
					}
					return this;
				}
				if(this.isResolved){ 
					var rs = this["@defer.result"];
					var ret = this["@defer.apply"]? cb.apply(this,rs):cb.call(this,rs);
					if(ret!=='%reenter' && ret!=='%retenter%interrupt')return this;
				} 
				(this["@defer.success"] || (this["@defer.success"]=[])).push(cb);
				return this;
			},
			fail : function(cb,remove){
				if(!cb)return this;
				if(remove){
					var its = this["@defer.fail"]
					if(its)for(var i=0,j=its.length;i<j;i++){
						if((it=its.shift())!==cb) its.push(it);
					}
					return this;
				}
				if(this.isRejected){ 
					var rs = this["@defer.result"];
					var ret = this["@defer.apply"]? cb.apply(this,rs):cb.call(this,rs);
					if(ret!=='%reenter' && ret!=='%retenter%interrupt')return this;
				} 
				(this["@defer.fail"] || (this["@defer.fail"]=[])).push(cb);
				return this;
			},
			change : function(cb,remove){
				if(!cb)return this;
				if(remove){
					var its = this["@defer.change"]
					for(var i=0,j=its.length;i<j;i++){
						if((it=its.shift())!==cb) its.push(it);
					}
					return this;
				}
				(this["@defer.change"] || (this["@defer.change"]=[])).push(cb);
				return this;
			},
			then : function(success,fail,change){
				if(success) this.success(success);
				if(fail)this.fail(fail);
				if(change) this.change(change);
				return this;
			},
			always : function(cb,remove){
				if(remove){
					var its = this["@defer.success"]
					if(its)for(var i=0,j=its.length;i<j;i++){
						if((it=its.shift())!==cb) its.push(it);
					}
					its = this["@defer.fail"]
					if(its)for(var i=0,j=its.length;i<j;i++){
						if((it=its.shift())!==cb) its.push(it);
					}
					return this;
				}
				var rs = this["@defer.result"];
				var apply = this["@defer.apply"];
				if(this.isRejected || this.isResolved){
					var ret = apply? cb.apply(this,rs):cb.call(this,rs);
					if(ret==='%discard')return this;
				} 
				(this["@defer.fail"] || (this["@defer.fail"]=[])).push(cb);
				(this["@defer.success"] || (this["@defer.success"]=[])).push(cb);
			},
			promise : function(tgt){
				if(!tgt){
					if(this["@defer.promiseFrom"]) return this;
					tgt = {};
				}else if(tgt===this) throw "Can not promise self.";
				tgt.always = function(cb,remove){tgt["@defer.promiseFrom"].always(cb,remove);return this;}
				tgt.then = function(succcess,fail,change){tgt["@defer.promiseFrom"].then(success,fail,change);return this;}
				tgt.success = function(cb,remove){tgt["@defer.promiseFrom"].success(cb,remove);return this;}
				tgt.change = function(cb,remove){tgt["@defer.promiseFrom"].change(cb,remove);return this;}
				tgt.fail = function(cb,remove){tgt["@defer.promiseFrom"].fail(cb,remove);return this;}
				tgt.promise = function(targ){return (!targ || targ==this) ? this : tgt["@defer.promiseFrom"].promise(targ);}
				tgt["@defer.promiseFrom"] = me;
				return tgt;
			}
		};//end Defer.prototype
		        
        yi.defer = Global.$defer = function(args,delay,param){
			if(!args)return new Defer();
			var t = typeof args;
			if(t==='function')return new Defer(args,delay,param);
			if(t!=='object')return new Defer(undefined,undefined,param);
			
			var fn = function(defer){
				var result = t.length && t.push && t.pop ?[]:{},hasError = false,c=0,total =0;
				var dfs = args;
				for(var n in dfs){
					total++;c++;
					(function(index,df){
						if(!df.success || !df.fail) df = new Defer(df);
						df.success(function(rs){
							result[index] = rs;
							if(hasError) return "%discard";
							if(--c==0) defer.resolve(result);
							defer.change(c,total);
							return "%discard";
						}).fail(function(err){
							if(hasError) return "%discard";
							defer.fail({
								index:index,
								error:err
							});
							return "%discard";
						});
					})(n,dfs[n]);
				}
			}
			var defer = new Defer(fn,delay,param);
			return defer;
		}
		yi.makeArray = function(its){
			var ret =[];for(var i in its) ret.push(its[i]);return ret;
		}	
		var slice = Array.prototype.slice;



		var hd = document.getElementsByTagName("HEAD");
		hd = hd[0]|| document.body || document.documentElement;
		var loadRes = yi.loadRes = function(url,type){
			var df = new Defer(),elem;
			if(type==='.js'){
				elem = document.createElement("SCRIPT");
				elem.src = url;
			}else if(type==='.css'){
				elem = document.createElement("LINK");
				elem.href = url;elem.type ="text/css";elem.rel = "stylesheet";
			}else if(type ==='.img'){
				elem = document.createElement("img");
			}
			df.element = elem;
			elem.onerror = function(){df.reject(this);}
			if(elem.onload || elem.onload===null) elem.onload = function(){df.resolve(this);};
			else elem.onstatechange = function(){if(elem.readyState===4 || elem.readyState==='complete')df.resolve(this);}
			if(type==='.img') elem.src = url;else hd.appendChild(elem);
			return df;
		}
		var waitingReqires=[],loadedRequire;
		var requireManager = {
			//被挂起的Require
			suspends : [],
			defineCount:0,
			//刚加载的Require
			loaded:null,
			//请求一个Require
			aquire : function(deps,initial){
				var req = new Require(initial);
				var suspend = {req:req,deps:deps,isLoading:false};
				this.suspends.push(suspend);
				if(this.suspends.length===1){
					suspend.isLoading = true;
					req.loadDeps(deps);
				}
				return req;
			},
			resetLoading:function(){
				this.defineCount = 0; 
				this.loaded = null;
			},
			//当某个req已经完成所有加载
			loadComplete : function(req){
				var suspends = this.suspends,resumes = [],removeCount= 0;
				for(var i=0,j=suspends.length;i<j;i++){
					var it = suspends.shift();
					if(it.req!==req) {
						suspends.push(it);
						if(!it.isLoading)resumes.push(it);
					}else removeCount++;
				}
				if(this.resuming)return removeCount;
				this.resuming = true;
				requireManager.loaded=null;this.defineCount = 0; 
				for(var i=0,j=resumes.length;i<j;i++){
					var it = resumes[i];
					it.isLoading = true;
					it.req.loadDeps(it.deps);
				}
				this.resuming=false;
				return removeCount;
			}

		};
		var reqid=0;
		var Require= yi.Require = function(init){
			this._waitingCount = 0;
			this._intial = init;
			this.id = reqid++;
			var mod = this.isModule = init?true:false;
			if(mod)requireManager.defineCount++;
			requireManager.loaded = this;
			//else loadedRequire.next = this;
		}
		Require.prototype = new Defer();
		Require.prototype.loadDeps = function(dep_names){
			
			yi.log(this.id + " invoke loadDeps",dep_names);
			var deps = {},me = this;
			this._waitingCount++;//loadDeps自己就是个waiting
			var c = this._loadingCount = dep_names.length;
			for(var i=0,j=c;i<j;i++){
				if(this.isRejected)break;
				//每加载一个依赖项就添加一个任务计数
				this._waitingCount++;

				var dep_name = url = dep_names[i];
				var dep = deps[dep_name] = {name:dep_name};
				//var dep_req = cached[dep_name];
				//if(dep_req)
				(function(dep,me){
					loadRes(url,".js").success(function(){me._depLoaded(dep);}).fail(function(elem){
						me.reject({src : this,args : elem});
					});
				})(dep,this);
			}
			this._deps = deps;
			//任务结束
			if(--this._waitingCount==0 && !this.isRejected) this._ready();
			return this;
		}
		Require.prototype._depLoaded = function(res){
			yi.log(res.name + " is into _depLoaded.");
			//每完成一次加载，就减去一次任务计数
			var me = this;this._waitingCount--;
			if(requireManager.defineCount>1){
				var error = "Module should only define once in a file["+res.name+"].";
				this.reject({error: error,res:res});
				throw error;
				return;
			}
			var loaded = requireManager.loaded;
			if(!loaded){
				//刚加载的没有module ,当作已经调用过了init
				yi.log(me.id + " loaded a non-module js->" + res.name);
				if(this._waitingCount===0)this._ready();
				
			}else{
				yi.log( me.id + " is waiting " + loaded.id);
				//里面有require/define，可能发生等待，添加一个任务计数(等待依赖项变成ready状态)
				me._waitingCount++;
				loaded.success(function(){
					//依赖项变成了ready，相关的任务计数减一
					if(--me._waitingCount===0) me._ready();
				});
			}
			//刚加载的Require已经处理，清空Require,下次callback的时候loadedRequire里面始终是最近一次加载的js里面的Require
			requireManager.resetLoading();
			if(--this._loadingCount==0){
				if(requireManager.loadComplete(this)==0) throw "There are no require in require manager.";
			}
		}
		Require.prototype._ready = function(){
			if(!this._initial){
				yi.log(this.id + " resolved with not initial.");
				this.resolve();return;
			}
			var args = [],deps = this._deps;
			for(var n in deps) args.push(deps[n].result);
			this._initial.call(this,args);
			var me = this;
			this.success(function(value){
				me.module_instance = value;
			});
		}
		var require = yi.require = Global.$require = function(_deps){
			var deps = typeof _deps==='string'?slice.call(arguments):_deps;
			var req = requireManager.aquire(deps);
			return req;
		}
		yi.define = Global.$define= function(deps,initial){
			var req = requireManager.aquire(deps,initial);
			return req;
		}

		var protocols = require.protocols = ["http://","https://"];
		Require.basUrl = "";

		var paths = {},resolvedPaths={},cachedRequire = {};
		var Uri = yi.Uri = function(url){
			this.url = url;
			this.isAbsolute = false;
			for(var i=0,j=protocols.length;i<j;i++){
				var protocol = protocols[i];
				if(url.substr(0,protocol.length)=== protocol){
					this.isAbsolute = true;
					this.protocol = protocol;
					break;
				}
			}
			var q = url.indexOf("?");
			if(q<0){
				this.path = url;
			}else {
				this.path = url.substr(0,at);
				this.qs = url.substr(at);
			}
			var f = this.path.lastIndexOf("/");
			if(f>=0) this.file = this.path.substr(f);
			else this.file = this.path;
			var e = this.file.lastIndexOf(".");
			if(e>=0) this.ext = this.file.substr(e);
			this.toString = function(){return this.url ;}
		}

		var resolveUrl = require.resolveUrl = function(name){
			var uri,replaced = false;
			if(uri = resolvedPaths[name])return uri;
			var url = name;
			for(var n in paths){
				if(name.indexOf(n)==0 && name[n.length]==='/'){
					var k = paths[n];
					url =  k + name.substring(n.length);
					replaced = k;
					break;
				}
			}
			uri = new Uri(url);
			if(!uri.isAbsolute) {
				uri.url = Require.baseUrl + uri.url;
				this.isAbsolute = true;
			}
			if(uri.qs===undefined){ resolvedPaths[name] = uri; uri.cached = name;}
			return uri;
		}
		var imgexts = require.imageExts = [".gif",".png",".jpg"];
		var isImageExt = require.isImageExt = function(ext){
			for(var i=0,j=imgexts.length;i<j;i++) if(imgexts[i]===ext)return true;
			return false;
		}

		 Global.$log = yi.log = function(){
			try{
				console.log.apply(console,arguments);
			}catch(e){}
		}
    })(window,document);
	$require(["req-b.js"]).success(function(b){
		alert();
	});
</script>
</body>
</html>
